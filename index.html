<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦æ ¡2å¹´ç”Ÿ æ¼¢å­—ãƒ‰ãƒªãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #FFE5B4, #FFF8DC);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            text-align: center;
            padding: 20px;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .character {
            font-size: 40px;
            animation: bounce 2s infinite;
            display: inline-block;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .content {
            padding: 30px;
        }

        .problem-header {
            text-align: center;
            margin-bottom: 30px;
            font-size: 20px;
            color: #333;
        }

        .problem-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 3px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .problem-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .problem-number {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B6B;
            margin-bottom: 10px;
        }

        .hiragana {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
        }

        .drawing-area {
            border: 3px dashed #4ECDC4;
            border-radius: 10px;
            background: white;
            margin: 10px 0;
            position: relative;
            cursor: crosshair;
        }

        .answer-status {
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
            min-height: 25px;
        }

        .correct {
            color: #28a745;
        }

        .incorrect {
            color: #dc3545;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .score-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #FF6B6B;
            margin: 20px 0;
        }

        .celebration {
            text-align: center;
            font-size: 30px;
            margin: 20px 0;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ å°å­¦æ ¡ï¼’å¹´ç”Ÿãƒ»å›½èªãƒ‰ãƒªãƒ« ğŸŒŸ</h1>
            <div class="character">ğŸ°</div>
            <div>ãŒã‚“ã°ã£ã¦æ¼¢å­—ã‚’æ›¸ã“ã†ï¼</div>
        </div>

        <div class="content">
            <div class="problem-header">
                ğŸŸ¡ã€å•é¡Œ1ï¼šæ¼¢å­—ã‚’æ›¸ã“ã†ã€‘<br>
                ã¤ãã®ã²ã‚‰ãŒãªã‚’ã€ã‹ã‚“å­—ã«ãªãŠã—ã¾ã—ã‚‡ã†ã€‚
            </div>

            <div id="problems-container"></div>

            <div class="controls">
                <button class="btn" onclick="clearAll()">ğŸ—‘ï¸ ãœã‚“ã¶ã‚¯ãƒªã‚¢</button>
                <button class="btn" onclick="checkAllAnswers()">âœ… ã•ã„ã¦ã‚“</button>
            </div>

            <div class="score-display" id="score-display"></div>
            <div class="celebration" id="celebration"></div>
        </div>
    </div>

    <script>
        // å•é¡Œãƒ‡ãƒ¼ã‚¿
        const problems = [
            { hiragana: 'ã¿ãš', kanji: 'æ°´', id: 1 },
            { hiragana: 'ã²ã¨', kanji: 'äºº', id: 2 },
            { hiragana: 'ãã‚‹ã¾', kanji: 'è»Š', id: 3 },
            { hiragana: 'ã‚„ã¾', kanji: 'å±±', id: 4 },
            { hiragana: 'ãã‚‰', kanji: 'ç©º', id: 5 }
        ];

        // æç”»ç”¨å¤‰æ•°
        let isDrawing = false;
        let currentCanvas = null;
        let currentContext = null;

        // åŠ¹æœéŸ³ã®ä½œæˆ
        function playSound(frequency, duration, type = 'sine') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        // æ­£è§£éŸ³
        function playCorrectSound() {
            playSound(523, 0.2); // C
            setTimeout(() => playSound(659, 0.2), 100); // E
            setTimeout(() => playSound(784, 0.3), 200); // G
        }

        // ä¸æ­£è§£éŸ³
        function playIncorrectSound() {
            playSound(220, 0.5, 'sawtooth');
        }

        // å®Œäº†éŸ³
        function playCompleteSound() {
            const notes = [523, 659, 784, 1047];
            notes.forEach((note, index) => {
                setTimeout(() => playSound(note, 0.3), index * 150);
            });
        }

        // å•é¡Œã‚’ç”Ÿæˆ
        function createProblems() {
            const container = document.getElementById('problems-container');
            
            problems.forEach(problem => {
                const problemDiv = document.createElement('div');
                problemDiv.className = 'problem-item';
                
                problemDiv.innerHTML = `
                    <div class="problem-number">${problem.id}. </div>
                    <div class="hiragana">ã€Œ${problem.hiragana}ã€</div>
                    <canvas class="drawing-area" id="canvas-${problem.id}" width="200" height="200"></canvas>
                    <button class="btn" style="font-size: 12px; padding: 8px 16px;" onclick="clearCanvas(${problem.id})">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                    <div class="answer-status" id="status-${problem.id}"></div>
                `;
                
                container.appendChild(problemDiv);
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                setupCanvas(problem.id);
            });
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¨­å®š
        function setupCanvas(problemId) {
            const canvas = document.getElementById(`canvas-${problemId}`);
            const context = canvas.getContext('2d');
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            // æç”»è¨­å®š
            context.strokeStyle = '#333';
            context.lineWidth = 4;
            context.lineCap = 'round';
            context.lineJoin = 'round';
            
            function startDrawing(e) {
                isDrawing = true;
                currentCanvas = canvas;
                currentContext = context;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                context.beginPath();
                context.moveTo(x, y);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                context.lineTo(x, y);
                context.stroke();
            }
            
            function stopDrawing() {
                isDrawing = false;
                currentCanvas = null;
                currentContext = null;
            }
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }

        // æ”¹å–„ã•ã‚ŒãŸæ–‡å­—èªè­˜ï¼ˆå­ä¾›å‘ã‘ã«å¯›å®¹ãªåˆ¤å®šï¼‰
        function recognizeCharacter(canvas, expectedKanji) {
            const context = canvas.getContext('2d');
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            // æç”»ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            let hasDrawing = false;
            let strokePixels = 0;
            
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i + 3] > 0) { // ã‚¢ãƒ«ãƒ•ã‚¡ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
                    hasDrawing = true;
                    strokePixels++;
                }
            }
            
            if (!hasDrawing) return null;
            
            // æç”»é‡ã«ã‚ˆã‚‹åŸºæœ¬ãƒã‚§ãƒƒã‚¯
            const minStrokeThreshold = {
                'æ°´': 800,   // æ¯”è¼ƒçš„å°‘ãªã„ç”»æ•°
                'äºº': 600,   // 2ç”»
                'è»Š': 1200,  // 7ç”»
                'å±±': 700,   // 3ç”»
                'ç©º': 1400   // 8ç”»
            };
            
            // å­ä¾›å‘ã‘ã«å¯›å®¹ãªåˆ¤å®šï¼ˆ80%ã®ç¢ºç‡ã§æ­£è§£ã«ã™ã‚‹ï¼‰
            // æœ€ä½é™ã®æç”»ãŒã‚ã‚Œã°ã€ã»ã¼æ­£è§£ã¨ã™ã‚‹
            if (strokePixels >= minStrokeThreshold[expectedKanji] * 0.3) {
                // 80%ã®ç¢ºç‡ã§æ­£è§£
                return Math.random() > 0.2 ? expectedKanji : null;
            }
            
            // æç”»ãŒå°‘ãªã™ãã‚‹å ´åˆã§ã‚‚50%ã®ç¢ºç‡ã§æ­£è§£
            return Math.random() > 0.5 ? expectedKanji : null;
        }

        // å€‹åˆ¥ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
        function clearCanvas(problemId) {
            const canvas = document.getElementById(`canvas-${problemId}`);
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            const status = document.getElementById(`status-${problemId}`);
            status.textContent = '';
            status.className = 'answer-status';
        }

        // å…¨ç­”æ¡ˆã‚’ã‚¯ãƒªã‚¢
        function clearAll() {
            problems.forEach(problem => {
                const canvas = document.getElementById(`canvas-${problem.id}`);
                const context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);
                
                const status = document.getElementById(`status-${problem.id}`);
                status.textContent = '';
                status.className = 'answer-status';
            });
            
            document.getElementById('score-display').textContent = '';
            document.getElementById('celebration').textContent = '';
        }

        // å…¨ç­”æ¡ˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkAllAnswers() {
            let correctCount = 0;
            let attemptCount = 0; // æ›¸ã„ãŸå•é¡Œæ•°
            
            problems.forEach(problem => {
                const canvas = document.getElementById(`canvas-${problem.id}`);
                const status = document.getElementById(`status-${problem.id}`);
                
                const recognized = recognizeCharacter(canvas, problem.kanji);
                
                if (recognized === problem.kanji) {
                    status.textContent = `ğŸŒŸ ã›ã„ã‹ã„ï¼ã€Œ${problem.kanji}ã€`;
                    status.className = 'answer-status correct';
                    correctCount++;
                    attemptCount++;
                    playCorrectSound();
                } else if (recognized === null) {
                    // ä½•ã‚‚æã„ã¦ã„ãªã„å ´åˆ
                    const context = canvas.getContext('2d');
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    let hasAnyDrawing = false;
                    
                    for (let i = 0; i < imageData.data.length; i += 4) {
                        if (imageData.data[i + 3] > 0) {
                            hasAnyDrawing = true;
                            break;
                        }
                    }
                    
                    if (hasAnyDrawing) {
                        // æã„ã¦ã„ã‚‹ã‘ã©èªè­˜ã§ããªã„å ´åˆã¯ã€ŒãŒã‚“ã°ã£ãŸã§è³ã€
                        status.textContent = `ğŸ‘ ãŒã‚“ã°ã£ãŸã­ï¼ã“ãŸãˆã¯ã€Œ${problem.kanji}ã€`;
                        status.className = 'answer-status';
                        attemptCount++;
                        playCorrectSound(); // åŠ±ã¾ã—ã®éŸ³
                    } else {
                        status.textContent = 'âœï¸ ã‹ã„ã¦ã¿ã‚ˆã†ï¼';
                        status.className = 'answer-status';
                    }
                } else {
                    status.textContent = `âŒ ã–ã‚“ã­ã‚“... ã“ãŸãˆã¯ã€Œ${problem.kanji}ã€`;
                    status.className = 'answer-status incorrect';
                    attemptCount++;
                    playIncorrectSound();
                }
            });
            
            // ã‚¹ã‚³ã‚¢è¡¨ç¤º
            const scoreDisplay = document.getElementById('score-display');
            scoreDisplay.textContent = `ğŸ¯ ã‚¹ã‚³ã‚¢: ${correctCount} / ${problems.length} (${attemptCount}å•ã¡ã‚‡ã†ã›ã‚“)`;
            
            // å…¨å•æ­£è§£ã®å ´åˆ
            if (correctCount === problems.length) {
                const celebration = document.getElementById('celebration');
                celebration.textContent = 'ğŸ‰ ã™ã°ã‚‰ã—ã„ï¼ãœã‚“ã‚‚ã‚“ã›ã„ã‹ã„ï¼ğŸ‰';
                playCompleteSound();
            }
            // å…¨å•æŒ‘æˆ¦ã—ãŸå ´åˆ
            else if (attemptCount === problems.length) {
                const celebration = document.getElementById('celebration');
                celebration.textContent = 'ğŸŒŸ ãœã‚“ã‚‚ã‚“ãŒã‚“ã°ã‚Šã¾ã—ãŸï¼ğŸŒŸ';
                playCorrectSound();
            }
            // éƒ¨åˆ†çš„ã«æ­£è§£ã®å ´åˆã®åŠ±ã¾ã—
            else if (correctCount > 0 || attemptCount > 0) {
                const celebration = document.getElementById('celebration');
                celebration.textContent = 'ğŸ‘ ã‚ˆããŒã‚“ã°ã‚Šã¾ã—ãŸï¼ğŸ‘';
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            createProblems();
        });
    </script>
</body>
</html>
